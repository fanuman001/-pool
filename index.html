<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE Ultimate - æ•´åˆè¨ˆç®—åˆ†å¸³ç‰ˆ</title>
    <style>
        :root { --blue: #00d2ff; --red: #ff4757; --green: #2ed573; --gold: #ffa502; --bg: #0d1117; --card: #1c222b; --border: #30363d; --gray: #8b949e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 12px; padding-bottom: 50px; }
        
        /* é€šç”¨å…ƒä»¶ */
        .card { background: var(--card); padding: 18px; border-radius: 20px; margin-bottom: 12px; border: 1px solid var(--border); }
        h2 { font-size: 15px; color: var(--gold); margin: 0 0 15px 0; border-left: 3px solid var(--gold); padding-left: 10px; }
        .btn-main { width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; border: none; cursor: pointer; background: var(--gold); color: #000; font-size: 16px; transition: 0.2s; }
        .btn-main:active { transform: scale(0.98); }

        /* éŠæˆ²è¨ˆç®—å€æ¨£å¼ */
        .config-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .config-box { background: #000; padding: 10px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .config-box span { font-size: 11px; color: var(--gray); display: block; }
        .big-in { width: 100%; background: none; border: none; color: var(--gold); text-align: center; font-size: 18px; font-weight: bold; outline: none; }
        
        .p-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .p-btn { padding: 15px 5px; background: #21262d; border: 2px solid var(--border); border-radius: 12px; text-align: center; font-weight: bold; position: relative; cursor: pointer; }
        .t-1 { border-color: var(--blue) !important; color: var(--blue); }
        .t-2 { border-color: var(--red) !important; color: var(--red); }
        .score-badge { position: absolute; top: -8px; right: -5px; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 900; }
        .win-tag { background: var(--green); color: #000; }
        .loss-tag { background: var(--red); color: #fff; }

        /* å¸³æœ¬å€æ¨£å¼ */
        .ledger-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #111; border-radius: 10px; margin-bottom: 8px; border: 1px solid #222; }
        .share-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .p-block { background: #000; border: 1px solid #333; border-radius: 10px; padding: 8px; text-align: center; }
        .p-name-tag { font-size: 12px; color: var(--gray); margin-bottom: 5px; cursor: pointer; }
        .p-name-tag.active { color: var(--gold); font-weight: bold; }
        .mini-in { width: 80%; background: #222; border: 1px solid #444; color: #fff; text-align: center; border-radius: 5px; font-size: 12px; }

        /* æ¨™ç±¤æ»¾å‹• */
        .tags { display: flex; gap: 8px; overflow-x: auto; margin: 10px 0; padding-bottom: 5px; }
        .tag { background: #222; padding: 5px 12px; border-radius: 15px; font-size: 12px; white-space: nowrap; border: 1px solid #444; }
    </style>
</head>
<body>

<div class="card">
    <h2>âš”ï¸ å¯¦æ™‚å€ç‡è¨ˆç®— (Game)</h2>
    <div class="config-grid">
        <div class="config-box"><span>åº•é‡‘</span><input id="v-base" class="big-in" type="number" value="75" oninput="render()"></div>
        <div class="config-box"><span>çƒåƒ¹</span><input id="v-ball" class="big-in" type="number" value="25" oninput="render()"></div>
        <div class="config-box"><span>åª½åƒ¹</span><input id="v-egg" class="big-in" type="number" value="50" oninput="render()"></div>
    </div>
    
    <div id="p-grid" class="p-grid"></div>
    <div id="team-controls" style="margin-top:15px;"></div>
    
    <button class="btn-main" style="background:var(--blue); margin-top:15px;" onclick="importGameToLedger()">ğŸš€ çµå–®ï¼šå°‡æœ¬å±€é‡‘é¡å¯«å…¥å¸³æœ¬</button>
</div>

<div class="card">
    <h2>ğŸ± ç”Ÿæ´»é›œæ”¯ (Ledger)</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
        <select id="payer-id" style="background:#000; color:#fff; padding:10px; border-radius:8px; border:1px solid #444;"></select>
        <input type="number" id="exp-amt" placeholder="ç¸½é‡‘é¡" style="background:#000; color:#fff; padding:10px; border-radius:8px; border:1px solid #444;">
    </div>
    <input type="text" id="exp-note" placeholder="é …ç›®å‚™è¨» (å¦‚ï¼šè¨ˆç¨‹è»Šã€é£²æ–™)" style="width:100%; box-sizing:border-box; background:#000; color:#fff; padding:10px; border-radius:8px; border:1px solid #444;">
    
    <div id="share-grid" class="share-grid"></div>
    <button class="btn-main" style="margin-top:15px; height: 50px;" onclick="addExpense()">âœ… é€å‡ºé›œæ”¯å–®</button>
</div>

<div class="card">
    <h2>ğŸ‘¤ æˆå“¡ç¸½å¸³é¤˜é¡ (Total)</h2>
    <div id="ledger-list"></div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
        <button class="btn-main" style="background:var(--card); color:var(--gold); border:1px solid var(--gold);" onclick="runSmartSettle()">ğŸ’¡ çµç®—å»ºè­°</button>
        <button class="btn-main" style="background:var(--card); color:var(--gray); border:1px solid var(--gray);" onclick="resetAll()">âš ï¸ å…¨åŸŸé‡ç½®</button>
    </div>
</div>

<script>
// åˆå§‹åŒ–æ•¸æ“š
let players = [
    {id: 1, name: "é˜¿æ˜", debt: 0}, {id: 2, name: "å°è¯", debt: 0},
    {id: 3, name: "å¤§å¼·", debt: 0}, {id: 4, name: "è€ç‹", debt: 0},
    {id: 5, name: "æ°å“¥", debt: 0}, {id: 6, name: "å‡±æ–‡", debt: 0}
];

// éŠæˆ²ç‹€æ…‹
let teams = [{id:1, e:0, k:0}, {id:2, e:0, k:0}];
let playerTeams = {1:1, 2:1, 3:2, 4:2}; // é è¨­ 2vs2
let winId = 1;

// æ ¸å¿ƒè¨ˆç®—é‚è¼¯
function calculateGame() {
    const base = Number(document.getElementById('v-base').value);
    const ball = Number(document.getElementById('v-ball').value);
    const eggU = Number(document.getElementById('v-egg').value);
    const mults = { 0:0, 1:1, 2:3, 3:4, 4:6 };
    
    let sc = {}; players.forEach(p => sc[p.id] = 0);
    const on = players.filter(p => playerTeams[p.id] > 0);
    if (!on.length) return sc;

    let tMems = { 1: on.filter(p => playerTeams[p.id] === 1), 2: on.filter(p => playerTeams[p.id] === 2) };
    const maxN = Math.max(tMems[1].length, tMems[2].length);

    // 1. åº•é‡‘
    if (winId && maxN > 0) {
        const totalBase = base * maxN;
        const wins = tMems[winId], loss = tMems[winId === 1 ? 2 : 1];
        if (wins.length && loss.length) {
            loss.forEach(p => sc[p.id] -= (totalBase / loss.length));
            wins.forEach(p => sc[p.id] += (totalBase / wins.length));
        }
    }

    // 2. çƒæ•¸èˆ‡åª½çƒ
    [1, 2].forEach(tid => {
        const mems = tMems[tid], opp = tMems[tid === 1 ? 2 : 1];
        if (!mems.length || !opp.length) return;
        
        const t = teams.find(x => x.id === tid);
        const eggValue = (eggU * mults[t.e]) * maxN;
        const ballValue = (t.k * ball) * maxN;
        const total = eggValue + ballValue;

        opp.forEach(p => sc[p.id] -= (total / opp.length));
        mems.forEach(p => sc[p.id] += (total / mems.length));
    });
    return sc;
}

function render() {
    const gameSc = calculateGame();
    
    // æ¸²æŸ“éŠæˆ²çƒå“¡æŒ‰éˆ•
    document.getElementById('p-grid').innerHTML = players.map(p => {
        const tid = playerTeams[p.id] || 0;
        const s = Math.round(gameSc[p.id] || 0);
        return `<div class="p-btn t-${tid}" onclick="toggleTeam(${p.id})">
            ${s !== 0 ? `<div class="score-badge ${s>0?'win-tag':'loss-tag'}">${s>0?'+'+s:s}</div>` : ''}
            ${p.name}
        </div>`;
    }).join('');

    // æ¸²æŸ“éŠæˆ²æ§åˆ¶é …
    document.getElementById('team-controls').innerHTML = teams.map(t => {
        return `<div style="background:#000; padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid #333;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b style="color:${t.id==1?'var(--blue)':'var(--red)'}">éšŠä¼ ${t.id}</b>
                <div>
                    çƒ: <button onclick="adjK(${t.id},-1)">-</button> <b>${t.k}</b> <button onclick="adjK(${t.id},1)">+</button>
                    | åª½: <button onclick="adjE(${t.id})"><b>${t.e}</b></button>
                    <button onclick="setWin(${t.id})" style="margin-left:10px; border:none; border-radius:5px; background:${winId==t.id?'var(--green)':'#333'}">${winId==t.id?'ğŸ†':'è´?'}</button>
                </div>
            </div>
        </div>`;
    }).join('');

    // æ¸²æŸ“å¸³æœ¬é¤˜é¡
    document.getElementById('ledger-list').innerHTML = players.map(p => `
        <div class="ledger-row">
            <span>ğŸ‘¤ ${p.name}</span>
            <b style="color:${p.debt>=0?'var(--green)':'var(--red)'}">${p.debt>=0?'+':''}${Math.round(p.debt)}</b>
        </div>`).join('');

    // æ¸²æŸ“åˆ†æ”¤é¸å–®
    document.getElementById('payer-id').innerHTML = players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    document.getElementById('share-grid').innerHTML = players.map(p => `
        <div class="p-block">
            <div class="p-name-tag active" data-id="${p.id}" onclick="this.classList.toggle('active')">${p.name}</div>
            <input type="number" class="mini-in" data-id="${p.id}" placeholder="0">
        </div>`).join('');
}

// å‹•ä½œå‡½æ•¸
function toggleTeam(pid) { playerTeams[pid] = (playerTeams[pid] + 1) % 3; render(); }
function adjK(tid, v) { const t = teams.find(x => x.id === tid); t.k = Math.max(0, t.k + v); render(); }
function adjE(tid) { const t = teams.find(x => x.id === tid); t.e = (t.e + 1) % 5; render(); }
function setWin(id) { winId = id; render(); }

// æ ¸å¿ƒæ•´åˆï¼šå°‡éŠæˆ²é‡‘é¡ä½µå…¥å¸³å‹™
function importGameToLedger() {
    if(!confirm("ç¢ºå®šçµå–®ä¸¦åŒ¯å…¥å¸³æœ¬å—ï¼Ÿæœ¬å±€æ•¸æ“šå°‡æ¸…ç©ºã€‚")) return;
    const gameSc = calculateGame();
    players.forEach(p => p.debt += (gameSc[p.id] || 0));
    // æ¸…ç©ºæœ¬å±€çƒæ•¸
    teams.forEach(t => { t.k = 0; t.e = 0; });
    render();
    alert("âœ… éŠæˆ²æ•¸æ“šå·²æˆåŠŸç´¯è¨ˆè‡³å¸³æœ¬é¤˜é¡ï¼");
}

// é›œæ”¯åˆ†æ”¤
function addExpense() {
    const total = parseFloat(document.getElementById('exp-amt').value) || 0;
    const payerId = parseInt(document.getElementById('payer-id').value);
    if(total <= 0) return alert("è«‹è¼¸å…¥é‡‘é¡");

    let autoMems = [], manualTotal = 0, shares = {};
    document.querySelectorAll('.p-block').forEach(blk => {
        const id = parseInt(blk.querySelector('.p-name-tag').dataset.id);
        const val = parseFloat(blk.querySelector('.mini-in').value) || 0;
        if(val > 0) { shares[id] = val; manualTotal += val; }
        else if(blk.querySelector('.p-name-tag').classList.contains('active')) { autoMems.push(id); }
    });

    const remain = total - manualTotal;
    if(autoMems.length > 0 && remain > 0) {
        autoMems.forEach(id => shares[id] = (shares[id] || 0) + (remain / autoMems.length));
    }

    players.forEach(p => {
        const benefit = (p.id === payerId ? total : 0) - (shares[p.id] || 0);
        p.debt += benefit;
    });

    document.getElementById('exp-amt').value = "";
    document.getElementById('exp-note').value = "";
    render();
}

function runSmartSettle() {
    let d = players.filter(p => p.debt < -1).map(p => ({...p})), c = players.filter(p => p.debt > 1).map(p => ({...p})), res = "ğŸ’¡ å»ºè­°çµç®—æ–¹å¼ï¼š\n";
    d.forEach(db => { c.forEach(cr => { if(db.debt < 0 && cr.debt > 0) { let m = Math.min(Math.abs(db.debt), cr.debt); res += `${db.name} âœ ${cr.name} : $${Math.round(m)}\n`; db.debt += m; cr.debt -= m; } }); });
    alert(res);
}

function resetAll() { if(confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰å¸³å‹™å—ï¼Ÿ")) { players.forEach(p => p.debt = 0); render(); } }

render();
</script>
</body>
</html>

