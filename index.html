<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE HUB - PRO</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ... ä¿æŒä½ åŸæœ¬çš„ CSS ... */
        :root { 
            --blue: #00d2ff; --gold: #ffa502; --bg: #0d1117; 
            --card: #1c222b; --border: #30363d; --gray: #8b949e; 
            --red: #ff4757;
        }
        body { background: var(--bg); color: #e6edf3; font-family: -apple-system, system-ui, sans-serif; padding: 15px; max-width: 600px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h2 { letter-spacing: 2px; color: var(--blue); margin: 0; }
        
        /* æ–°å¢ï¼šç™¼é€æˆ°å ±çš„ç‰¹åˆ¥å€å¡Š */
        .broadcast-box {
            background: linear-gradient(145deg, #1e2530, #0d1117);
            border: 1px solid var(--gold);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(255, 165, 2, 0.15);
        }
        .broadcast-box h3 { color: var(--gold); margin: 0 0 10px 0; font-size: 18px; }
        
        .btn { padding: 12px 20px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-gold { background: var(--gold); color: #000; font-size: 16px; }
        .btn-gold:active { transform: scale(0.95); opacity: 0.9; }

        /* ... å…¶é¤˜æ¨£å¼ä¿æŒä¸è®Š ... */
        .nav-grid { display: grid; gap: 10px; }
        .nav-item { background: var(--card); border: 1px solid var(--border); padding: 14px 18px; border-radius: 16px; display: flex; align-items: center; text-decoration: none; color: inherit; margin-bottom: 10px; }
        .icon-box { width: 42px; height: 42px; background: rgba(255,255,255,0.03); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; border: 1px solid var(--border); }
        .group-title { font-size: 13px; color: var(--gray); margin: 25px 0 10px 5px; font-weight: bold; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .group-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }
    </style>
</head>
<body>

    <div class="header">
        <h2 id="user-name">ELITE HUB</h2>
        <button id="toggle-btn" style="background:none; border:1px solid #333; color:#888; padding:5px 10px; border-radius:8px;" onclick="checkAuth()">âš™ï¸</button>
    </div>

    <div id="broadcast-area" class="broadcast-box" style="display: none;">
        <h3>æˆ°å ±å»£æ’­ç³»çµ±</h3>
        <p style="font-size: 12px; color: var(--gray); margin-bottom: 15px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå°‡æœ€æ–°é‡‘åº«æ•¸æ“šç™¼é€åˆ° LINE ç¾¤çµ„</p>
        <button class="btn btn-gold" onclick="sendEliteFlex()">ğŸ“¢ ç™¼é€é»‘é‡‘æˆ°å ±å¡ç‰‡</button>
    </div>

    <div id="nav-list">ç³»çµ±è¼‰å…¥ä¸­...</div>

<script>
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
    const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json' };
    const LIFF_ID = "2008868088-9hbWzzlW";

    let currentPlayers = [];

    // 1. åˆå§‹åŒ– LIFF
    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isInClient()) {
                if (!liff.isLoggedIn()) { liff.login(); }
                const profile = await liff.getProfile();
                document.getElementById('user-name').innerText = "ELITE Â· " + profile.displayName;
                document.getElementById('broadcast-area').style.display = 'block'; // åªæœ‰åœ¨ LINE å…§æ‰é¡¯ç¤ºç™¼é€æŒ‰éˆ•
            }
        } catch (e) { console.log("Init error"); }
        fetchData();
    }

    // 2. ç²å–æ•¸æ“š (ç‚ºäº†ç™¼é€å¡ç‰‡æ™‚æœ‰æœ€æ–°è³‡æ–™)
    async function fetchData() {
        try {
            const [navRes, playerRes] = await Promise.all([
                fetch(`${API_URL}/nav_links?select=*&order=category.asc`, { headers: HEADERS }),
                fetch(`${API_URL}/players?select=*`, { headers: HEADERS })
            ]);
            const links = await navRes.json();
            currentPlayers = await playerRes.json();
            render(links);
        } catch (e) { document.getElementById('nav-list').innerText = "é€£ç·šå¤±æ•—"; }
    }

    // 3. ç™¼é€é»‘é‡‘å¡ç‰‡æ ¸å¿ƒåŠŸèƒ½
    async function sendEliteFlex() {
        // æ•´ç†å‰ä¸‰åæˆ–çµé¤˜æ•¸æ“š
        const topSummary = currentPlayers
            .filter(p => !p.name.startsWith('OFF_'))
            .sort((a, b) => (b.money + b.debt) - (a.money + a.debt))
            .slice(0, 5) // å–å‰äº”å
            .map(p => `${p.name}: $${Math.round(p.money + p.debt)}`)
            .join('\n');

        try {
            const result = await liff.shareTargetPicker([
                {
                    "type": "flex",
                    "altText": "ğŸ† ELITE èè‹±æˆ°å ±",
                    "contents": {
                        "type": "bubble",
                        "styles": { "header": { "backgroundColor": "#000000" }, "body": { "backgroundColor": "#1a1a1a" }, "footer": { "backgroundColor": "#1a1a1a" } },
                        "header": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": "ELITE SYSTEM", "color": "#ffa502", "weight": "bold", "size": "sm" }] },
                        "body": {
                            "type": "box", "layout": "vertical", "contents": [
                                { "type": "text", "text": "æœ€æ–°çµé¤˜æˆ°å ±", "color": "#ffffff", "size": "xl", "weight": "bold" },
                                { "type": "text", "text": topSummary, "color": "#eeeeee", "margin": "lg", "wrap": true, "fontStyle": "italic", "size": "sm" },
                                { "type": "separator", "margin": "xl", "color": "#333333" },
                                { "type": "text", "text": "é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŸ¥çœ‹æ‰€æœ‰æˆå“¡æ˜ç´°", "color": "#888888", "size": "xxs", "margin": "md" }
                            ]
                        },
                        "footer": {
                            "type": "box", "layout": "vertical", "contents": [{
                                "type": "button", "style": "primary", "color": "#ffa502",
                                "action": { "type": "uri", "label": "é€²å…¥ ELITE HUB", "uri": "https://liff.line.me/" + LIFF_ID }
                            }]
                        }
                    }
                }
            ]);
            if (result) alert("æˆ°å ±å·²é€å‡ºï¼");
        } catch (e) { alert("ç™¼é€å¤±æ•—ï¼Œè«‹ç¢ºèª LINE é–‹ç™¼è€…å¾Œå°å·²é–‹å•Ÿ ShareTargetPicker æ¬Šé™ã€‚"); }
    }

    // 4. æ¸²æŸ“é€£çµåˆ—è¡¨
    function render(data) {
        let html = "";
        let lastCat = "";
        data.forEach(item => {
            if (item.category !== lastCat) {
                html += `<div class="group-title">${item.category}</div>`;
                lastCat = item.category;
            }
            html += `
                <a href="${item.url}" class="nav-item">
                    <div class="icon-box">${item.icon || 'ğŸ”—'}</div>
                    <div class="title-text">${item.title}</div>
                    <div class="arrow">âœ</div>
                </a>`;
        });
        document.getElementById('nav-list').innerHTML = html;
    }

    window.onload = init;
</script>
</body>
</html>

