<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ELITE HUB - PRO</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { 
            --blue: #00d2ff; --gold: #ffa502; --bg: #0d1117; 
            --card: #1c222b; --border: #30363d; --gray: #8b949e; 
            --red: #ff4757;
        }
        body { background: var(--bg); color: #e6edf3; font-family: -apple-system, sans-serif; padding: 15px; max-width: 600px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h2 { letter-spacing: 2px; color: var(--blue); margin: 0; }

        /* æˆ°å ±é¸æ“‡å€ */
        .broadcast-box {
            background: linear-gradient(145deg, #1e2530, #0d1117);
            border: 1px solid var(--gold); padding: 18px; border-radius: 20px; margin-bottom: 25px;
        }
        .report-select {
            width: 100%; padding: 10px; background: #000; color: var(--gold);
            border: 1px solid var(--gold); border-radius: 10px; margin-bottom: 10px;
        }

        .anchor-nav { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 10px; scrollbar-width: none; }
        .anchor-btn { background: var(--card); border: 1px solid var(--border); color: var(--gray); padding: 6px 14px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; }
        
        .group-title { font-size: 13px; color: var(--gray); margin: 30px 0 12px 5px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .group-title::after { content: ""; flex: 1; height: 1px; background: var(--border); }

        .nav-grid { display: grid; gap: 10px; }
        .nav-item { 
            background: var(--card); border: 1px solid var(--border); padding: 14px 18px; 
            border-radius: 16px; display: flex; align-items: center; cursor: pointer; text-decoration: none; color: inherit;
        }
        .icon-box { width: 42px; height: 42px; background: rgba(255,255,255,0.03); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 15px; border: 1px solid var(--border); }
        
        .btn { padding: 10px 20px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-gold { background: var(--gold); color: #000; width: 100%; }
        .admin-box { background: #161b22; border: 1px solid var(--gold); padding: 18px; border-radius: 20px; margin-bottom: 25px; }
        input { width: 100%; padding: 12px; margin: 5px 0; border-radius: 10px; border: 1px solid #333; background: #000; color: #fff; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="header">
        <h2 id="hub-title">ELITE HUB</h2>
        <button class="btn" style="background:none; color:var(--gray)" onclick="checkAuth()">âš™ï¸</button>
    </div>

    <div class="broadcast-box">
        <h3 style="color: var(--gold); margin: 0 0 10px 0; font-size: 16px;">ç²¾è‹±æˆ°å ±å»£æ’­</h3>
        <select id="report-type" class="report-select">
            <option value="rank">ğŸ† ç¸½ç©åˆ†æ’å (Money + Debt)</option>
            <option value="money">ğŸ’° ç´”é‡‘åº«é¤˜é¡æ’è¡Œ</option>
            <option value="debt">ğŸ’¸ æ¬ æ¬¾å‚µå‹™æ¸…å–®</option>
        </select>
        <button class="btn btn-gold" onclick="sendEliteFlex()">ğŸ“¢ ç™¼é€æ‰€é¸æˆ°å ±</button>
    </div>

    <div id="anchor-list" class="anchor-nav"></div>

    <div id="add-form" class="admin-box" style="display: none;">
        <input type="text" id="in-category" placeholder="åˆ†é¡">
        <input type="text" id="in-title" placeholder="é€£çµåç¨±">
        <input type="text" id="in-url" placeholder="ç¶²å€">
        <button class="btn btn-gold" onclick="addNew()">ï¼‹ ç™¼ä½ˆ</button>
    </div>

    <div id="nav-list">è¼‰å…¥ä¸­...</div>

<script>
    const API_URL = 'https://nzuxyiefpenwuqudajdw.supabase.co/rest/v1';
    const KEY = 'sb_publishable_7y2n8zIopxlKEhcsJ05D2A_U89IFgae';
    const HEADERS = { 'apikey': KEY, 'Authorization': 'Bearer ' + KEY, 'Content-Type': 'application/json' };
    const LIFF_ID = "2008868088-9hbWzzlW";

    let currentPlayers = [];
    let currentData = [];

    async function init() {
        try {
            await liff.init({ liffId: LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                document.getElementById('hub-title').innerText = "ELITE Â· " + profile.displayName;
            } else {
                liff.login();
            }
        } catch (e) { console.log("LIFF Error"); }
        fetchData();
    }

    // ğŸ’¡ é—œéµåŠŸèƒ½ï¼šæ¬Šé™ç¹¼æ‰¿è·³è½‰
    function openLink(url) {
        if (liff.isInClient()) {
            // ä½¿ç”¨ liff.openWindow é–‹å•Ÿï¼Œå­é é¢æœƒç¹¼æ‰¿ LINE æˆæ¬Šç’°å¢ƒ
            liff.openWindow({
                url: url,
                external: false
            });
        } else {
            window.location.href = url;
        }
    }

    async function fetchData() {
        const [navRes, playerRes] = await Promise.all([
            fetch(`${API_URL}/nav_links?select=*&order=category.asc`, { headers: HEADERS }),
            fetch(`${API_URL}/players?select=*`, { headers: HEADERS })
        ]);
        currentData = await navRes.json();
        currentPlayers = await playerRes.json();
        render();
    }

    async function sendEliteFlex() {
        const type = document.getElementById('report-type').value;
        let title = "æˆ°å ±æ›´æ–°";
        let list = [];

        const players = currentPlayers.filter(p => !p.name.startsWith('OFF_'));

        if (type === 'rank') {
            title = "ğŸ† ç¸½ç©åˆ†æ’å";
            list = players.sort((a,b) => (b.money+b.debt)-(a.money+a.debt))
                   .map(p => `${p.name}: ${Math.round(p.money+p.debt)}`);
        } else if (type === 'money') {
            title = "ğŸ’° é‡‘åº«é¤˜é¡æ’è¡Œ";
            list = players.sort((a,b) => b.money-a.money)
                   .map(p => `${p.name}: $${p.money}`);
        } else {
            title = "ğŸ’¸ æ¬ æ¬¾å‚µå‹™æ¸…å–®";
            list = players.filter(p => p.debt !== 0)
                   .map(p => `${p.name}: ${p.debt}`);
        }

        const content = list.slice(0, 8).join('\n');

        await liff.shareTargetPicker([{
            "type": "flex",
            "altText": "ELITE æˆ°å ±: " + title,
            "contents": {
                "type": "bubble",
                "styles": { "header": { "backgroundColor": "#000000" }, "body": { "backgroundColor": "#1a1a1a" } },
                "header": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": title, "color": "#ffa502", "weight": "bold" }] },
                "body": { "type": "box", "layout": "vertical", "contents": [{ "type": "text", "text": content, "color": "#ffffff", "wrap": true, "size": "sm" }] }
            }
        }]);
    }

    function render() {
        let html = "";
        let groups = {};
        currentData.forEach(item => {
            if (!groups[item.category]) groups[item.category] = [];
            groups[item.category].push(item);
        });

        Object.keys(groups).forEach(cat => {
            html += `<div class="group-title">${cat}</div><div class="nav-grid">`;
            groups[cat].forEach(item => {
                // ğŸ’¡ æ”¹ç”¨ onclick="openLink" ç¢ºä¿æˆæ¬Šä¸éºå¤±
                html += `
                    <div onclick="openLink('${item.url}')" class="nav-item">
                        <div class="icon-box">${item.icon || 'ğŸ”—'}</div>
                        <div class="title-text">${item.title}</div>
                        <div class="arrow">âœ</div>
                    </div>`;
            });
            html += `</div>`;
        });
        document.getElementById('nav-list').innerHTML = html;
    }

    window.onload = init;
</script>
</body>
</html>

